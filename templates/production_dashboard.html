<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firewood Splitter Production Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #2d5a27 0%, #5d9e51 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-item {
            text-align: center;
        }
        .status-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .status-value {
            font-size: 20px;
            font-weight: bold;
            color: #2d5a27;
            margin-top: 5px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .stat-card.current-basket {
            border-left: 4px solid #5d9e51;
        }
        .stat-card.production-rates {
            border-left: 4px solid #f39c12;
        }
        .stat-card.system-status {
            border-left: 4px solid #3498db;
        }
        .stat-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        .stat-subtitle {
            font-size: 12px;
            color: #999;
        }
        .production-table {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        .btn {
            background: #5d9e51;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 14px;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #4a8042;
        }
        .btn.danger {
            background: #e74c3c;
        }
        .btn.danger:hover {
            background: #c0392b;
        }
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .metric-row:last-child {
            border-bottom: none;
        }
        .metric-label {
            font-weight: 600;
            color: #555;
        }
        .metric-value {
            font-family: 'Courier New', monospace;
            color: #2d5a27;
            font-weight: bold;
        }
        .stage-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .stage-idle {
            background: #ecf0f1;
            color: #7f8c8d;
        }
        .stage-extending {
            background: #fff3cd;
            color: #856404;
        }
        .stage-retracting {
            background: #d1ecf1;
            color: #0c5460;
        }
        .stage-active {
            background: #d4edda;
            color: #155724;
        }
        .last-updated {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 20px;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .progress-bar {
            background: #ecf0f1;
            border-radius: 10px;
            height: 8px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            background: #5d9e51;
            height: 100%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü™ì Firewood Splitter Production Dashboard</h1>
            <p>Real-time monitoring of hydraulic log splitter operations</p>
            <div style="text-align: center; margin-top: 15px;">
                <a href="/baskets" style="background-color: #007bff; color: white; text-decoration: none; padding: 8px 16px; border-radius: 4px; margin: 0 5px;">üìä Basket History</a>
                <a href="/viewer" style="background-color: #17a2b8; color: white; text-decoration: none; padding: 8px 16px; border-radius: 4px; margin: 0 5px;">üìà Data Viewer</a>
                <a href="/stats" style="background-color: #6f42c1; color: white; text-decoration: none; padding: 8px 16px; border-radius: 4px; margin: 0 5px;">üì° MQTT Stats</a>
                <a href="/monitor" style="background-color: #fd7e14; color: white; text-decoration: none; padding: 8px 16px; border-radius: 4px; margin: 0 5px;">üîß Monitor Control</a>
                <a href="/controller" style="background-color: #dc2626; color: white; text-decoration: none; padding: 8px 16px; border-radius: 4px; margin: 0 5px;">‚ö° Controller Control</a>
                <button onclick="exportData()" style="background-color: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 0 5px; cursor: pointer;">üíæ Export Data</button>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-label">Current Stage</div>
                <div class="status-value" id="current-stage">
                    <span class="stage-indicator stage-idle" id="stage-indicator">IDLE</span>
                </div>
            </div>
            <div class="status-item">
                <div class="status-label">System Status</div>
                <div class="status-value" id="system-status">Loading...</div>
            </div>
            <div class="status-item">
                <div class="status-label">Fuel Level</div>
                <div class="status-value" id="fuel-level">-- gal</div>
            </div>
            <div class="status-item">
                <div class="status-label">Temperature</div>
                <div class="status-value" id="temperature">--¬∞F</div>
            </div>
            <div class="status-item">
                <div class="status-label">Basket Progress</div>
                <div class="status-value" id="basket-progress">0 splits</div>
            </div>
            <div class="status-item">
                <div class="status-label">Session Uptime</div>
                <div class="status-value" id="session-uptime">0h 0m</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn" onclick="refreshData()">üîÑ Refresh Data</button>
            <button class="btn" onclick="completeBasket()">üóëÔ∏è Complete Basket</button>
            <button class="btn" id="break-btn" onclick="toggleBreak()">‚òï Start Break</button>
            <button class="btn danger" onclick="resetStats()">ÔøΩ Reset Statistics</button>
        </div>

        <div id="error-message" class="error" style="display: none;"></div>

        <div class="stats-grid">
            <div class="stat-card current-basket">
                <div class="stat-title">Current Basket</div>
                <div class="stat-value" id="current-basket-splits">0</div>
                <div class="stat-subtitle">Splits completed</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="basket-progress-bar" style="width: 0%"></div>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Duration:</span>
                    <span class="metric-value" id="basket-duration">0m 0s</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Cycles Attempted:</span>
                    <span class="metric-value" id="basket-cycles">0</span>
                </div>
            </div>

            <div class="stat-card production-rates">
                <div class="stat-title">Production Rates</div>
                <div class="stat-value" id="splits-per-hour">0</div>
                <div class="stat-subtitle">Splits per hour</div>
                <div class="metric-row">
                    <span class="metric-label">Baskets/Hour:</span>
                    <span class="metric-value" id="baskets-per-hour">0.0</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Avg Splits/Basket:</span>
                    <span class="metric-value" id="avg-splits-per-basket">0.0</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Current Rate:</span>
                    <span class="metric-value" id="current-basket-rate">0.0/hr</span>
                </div>
            </div>

            <div class="stat-card system-status">
                <div class="stat-title">Session Totals</div>
                <div class="stat-value" id="total-splits">0</div>
                <div class="stat-subtitle">Total splits</div>
                <div class="metric-row">
                    <span class="metric-label">Baskets:</span>
                    <span class="metric-value" id="total-baskets">0</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Cycles:</span>
                    <span class="metric-value" id="total-cycles">0</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Avg Cycle Time:</span>
                    <span class="metric-value" id="avg-cycle-time">0.0s</span>
                </div>
            </div>
        </div>

        <div class="production-table">
            <h3>Performance Metrics</h3>
            <div class="metric-row">
                <span class="metric-label">Completed Cycles:</span>
                <span class="metric-value" id="completed-cycles">0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Aborted Cycles:</span>
                <span class="metric-value" id="aborted-cycles">0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Success Rate:</span>
                <span class="metric-value" id="success-rate">100%</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Idle Time:</span>
                <span class="metric-value" id="idle-time">0m 0s</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Break Time:</span>
                <span class="metric-value" id="break-time">0m 0s</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Break Status:</span>
                <span class="metric-value" id="break-status">Not on break</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Active Cycle Duration:</span>
                <span class="metric-value" id="active-cycle-duration">0.0s</span>
            </div>
        </div>

        <div class="last-updated">
            Last updated: <span id="last-updated">Never</span>
        </div>
    </div>

    <script>
        let refreshInterval;

        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            if (typeof num === 'number') {
                return num.toLocaleString(undefined, { maximumFractionDigits: 1 });
            }
            return num;
        }

        function formatDuration(seconds) {
            if (!seconds || seconds < 0) return '0s';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function updateStageIndicator(stage) {
            const indicator = document.getElementById('stage-indicator');
            indicator.textContent = stage || 'IDLE';
            
            // Remove all stage classes
            indicator.className = 'stage-indicator';
            
            // Add appropriate class
            switch ((stage || '').toUpperCase()) {
                case 'EXTENDING':
                    indicator.classList.add('stage-extending');
                    break;
                case 'RETRACTING':
                    indicator.classList.add('stage-retracting');
                    break;
                case 'ACTIVE':
                    indicator.classList.add('stage-active');
                    break;
                default:
                    indicator.classList.add('stage-idle');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        async function refreshData() {
            try {
                const response = await fetch('/api/production/summary');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                // Update status bar
                updateStageIndicator(data.current_stage);
                document.getElementById('system-status').textContent = 
                    (data.system_status || 'unknown').toUpperCase();
                
                // Update fuel level
                const fuelLevel = data.current_fuel_level;
                document.getElementById('fuel-level').textContent = 
                    fuelLevel !== null && fuelLevel !== undefined ? 
                    `${fuelLevel.toFixed(1)} gal` : '-- gal';
                
                // Update temperature (prefer local, fallback to remote)
                const tempLocal = data.current_temperature_local;
                const tempRemote = data.current_temperature_remote;
                const displayTemp = tempLocal !== null && tempLocal !== undefined ? tempLocal : tempRemote;
                document.getElementById('temperature').textContent = 
                    displayTemp !== null && displayTemp !== undefined ? 
                    `${displayTemp.toFixed(0)}¬∞F` : '--¬∞F';
                
                document.getElementById('basket-progress').textContent = 
                    `${data.current_basket?.splits_completed || 0} splits`;
                document.getElementById('session-uptime').textContent = 
                    formatDuration(data.uptime_seconds);
                
                // Update current basket
                const currentBasket = data.current_basket || {};
                document.getElementById('current-basket-splits').textContent = 
                    formatNumber(currentBasket.splits_completed || 0);
                document.getElementById('basket-duration').textContent = 
                    formatDuration(currentBasket.basket_duration);
                document.getElementById('basket-cycles').textContent = 
                    formatNumber(currentBasket.cycles_attempted || 0);
                
                // Update basket progress bar (assuming 20 splits per basket)
                const expectedSplitsPerBasket = 20;
                const progressPercent = Math.min(100, 
                    ((currentBasket.splits_completed || 0) / expectedSplitsPerBasket) * 100);
                document.getElementById('basket-progress-bar').style.width = `${progressPercent}%`;
                
                // Update production rates
                const rates = data.production_rates || {};
                document.getElementById('splits-per-hour').textContent = 
                    formatNumber(rates.splits_per_hour || 0);
                document.getElementById('baskets-per-hour').textContent = 
                    formatNumber(rates.baskets_per_hour || 0);
                document.getElementById('avg-splits-per-basket').textContent = 
                    formatNumber(rates.average_splits_per_basket || 0);
                document.getElementById('current-basket-rate').textContent = 
                    formatNumber(rates.current_basket_splits_per_hour || 0) + '/hr';
                
                // Update session totals
                document.getElementById('total-splits').textContent = 
                    formatNumber(data.total_splits || 0);
                document.getElementById('total-baskets').textContent = 
                    formatNumber(data.total_baskets || 0);
                document.getElementById('total-cycles').textContent = 
                    formatNumber(data.total_cycles || 0);
                document.getElementById('avg-cycle-time').textContent = 
                    formatNumber(data.average_cycle_time || 0) + 's';
                
                // Update performance metrics
                document.getElementById('completed-cycles').textContent = 
                    formatNumber(data.completed_cycles || 0);
                document.getElementById('aborted-cycles').textContent = 
                    formatNumber(data.aborted_cycles || 0);
                
                const successRate = data.total_cycles > 0 ? 
                    ((data.completed_cycles || 0) / data.total_cycles * 100) : 100;
                document.getElementById('success-rate').textContent = 
                    formatNumber(successRate) + '%';
                
                document.getElementById('idle-time').textContent = 
                    formatDuration(data.idle_time_seconds);
                document.getElementById('active-cycle-duration').textContent = 
                    formatNumber(currentBasket.active_cycle_duration || 0) + 's';
                
                document.getElementById('last-updated').textContent = 
                    new Date().toLocaleTimeString();
                
                // Update break status
                await updateBreakStatus();
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                showError(`Failed to refresh data: ${error.message}`);
            }
        }

        async function completeBasket() {
            if (confirm('Complete the current basket and start a new one?')) {
                try {
                    const response = await fetch('/api/production/complete-basket', { method: 'POST' });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    const result = await response.json();
                    console.log('Basket completed:', result.message);
                    await refreshData();
                } catch (error) {
                    console.error('Error completing basket:', error);
                    showError(`Failed to complete basket: ${error.message}`);
                }
            }
        }

        // Break control functionality
        let currentBreakStatus = false;

        async function toggleBreak() {
            try {
                const endpoint = currentBreakStatus ? '/api/production/end-break' : '/api/production/start-break';
                const response = await fetch(endpoint, { method: 'POST' });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Break toggled:', result.message);
                await updateBreakStatus();
                await refreshData();
            } catch (error) {
                console.error('Error toggling break:', error);
                showError(`Failed to toggle break: ${error.message}`);
            }
        }

        async function updateBreakStatus() {
            try {
                const response = await fetch('/api/production/break-status');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const status = await response.json();
                currentBreakStatus = status.on_break;
                
                // Update button text and style
                const breakBtn = document.getElementById('break-btn');
                if (currentBreakStatus) {
                    breakBtn.textContent = '‚è∞ End Break';
                    breakBtn.style.backgroundColor = '#dc3545';  // Red for active break
                } else {
                    breakBtn.textContent = '‚òï Start Break';
                    breakBtn.style.backgroundColor = '';  // Default color
                }
                
                // Update break status display
                document.getElementById('break-status').textContent = 
                    currentBreakStatus ? 'On break' : 'Not on break';
                
                // Update break time display
                const breakTimeSeconds = status.break_duration || 0;
                const minutes = Math.floor(breakTimeSeconds / 60);
                const seconds = Math.floor(breakTimeSeconds % 60);
                document.getElementById('break-time').textContent = `${minutes}m ${seconds}s`;
                
            } catch (error) {
                console.error('Error updating break status:', error);
            }
        }

        function exportData() {
            // Create a temporary link element to trigger download
            const link = document.createElement('a');
            link.href = '/api/baskets/export';
            link.download = ''; // Let the server set the filename
            
            // Trigger the download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show a brief confirmation message
            const originalText = event.target.textContent;
            event.target.textContent = '‚úÖ Downloading...';
            event.target.disabled = true;
            
            setTimeout(() => {
                event.target.textContent = originalText;
                event.target.disabled = false;
            }, 2000);
        }

        async function resetStats() {
            if (confirm('Are you sure you want to reset all production statistics? This cannot be undone.')) {
                try {
                    const response = await fetch('/api/production/reset', { method: 'POST' });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    await refreshData();
                } catch (error) {
                    console.error('Error resetting stats:', error);
                    showError(`Failed to reset statistics: ${error.message}`);
                }
            }
        }

        // Auto-refresh every 2 seconds for production monitoring
        function startAutoRefresh() {
            refreshInterval = setInterval(refreshData, 2000);
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            startAutoRefresh();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', stopAutoRefresh);
    </script>
</body>
</html>